- name: Create project directory
  ansible.builtin.file:
    path: "{{ project_dir }}"
    state: directory
    mode: "0755"

- name: Copy compose file
  ansible.builtin.copy:
    src: "../../../deploy/compose.yml"
    dest: "{{ project_dir }}/compose.yml"
    mode: "0644"

- name: Render Caddyfile
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: "{{ project_dir }}/Caddyfile"
    mode: "0644"

- name: Create logs directory for Caddy
  ansible.builtin.file:
    path: "{{ project_dir }}/logs"
    state: directory
    mode: "0755"

- name: Create WordPress env file
  ansible.builtin.copy:
    dest: "{{ project_dir }}/wordpress.env"
    mode: "0600"
    content: |
      WP_DB_NAME={{ wp_db_name }}
      WP_DB_USER={{ wp_db_user }}
      WP_DB_PASSWORD={{ wp_db_password }}
      WP_DB_ROOT_PASSWORD={{ wp_db_root_password }}

- name: Create php config directory
  ansible.builtin.file:
    path: "{{ project_dir }}/php"
    state: directory
    mode: "0755"

- name: Copy custom php ini
  ansible.builtin.copy:
    src: "../../../deploy/php/custom.ini"
    dest: "{{ project_dir }}/php/custom.ini"
    mode: "0644"

- name: Deploy stack with docker compose
  ansible.builtin.command:
    chdir: "{{ project_dir }}"
    cmd: docker compose --env-file wordpress.env up -d
  changed_when: true
