#!/bin/bash
set -euo pipefail

SITE="{{ site_name }}"
BACKUP_DIR="{{ db_backup_dir }}"
TS="$(date +%F_%H%M%S)"

DB_NAME="{{ secret.wp_db_name }}"
DB_USER="{{ secret.wp_db_user }}"
DB_PASS="{{ secret.wp_db_password }}"

DB_CONTAINER="${SITE}_db"
OUT="${BACKUP_DIR}/${SITE}_${TS}.sql.gz"

TODAY="$(date +%F)"
TODAY_PATTERN="${BACKUP_DIR}/${SITE}_${TODAY}_*.sql.gz"

# If a backup for today already exists, exit cleanly
if compgen -G "${TODAY_PATTERN}" > /dev/null; then
  echo "Backup for today already exists. Exiting."
  exit 0
fi

mkdir -p "${BACKUP_DIR}"
chmod 700 "${BACKUP_DIR}"

# Vérif container présent (sinon on sort en erreur)
if ! docker ps --format '{{"{{"}}.Names{{"}}"}}' | grep -qx "${DB_CONTAINER}"; then
  echo "ERROR: DB container not running: ${DB_CONTAINER}" >&2
  exit 1
fi

# Dump depuis le container
docker exec "${DB_CONTAINER}" mariadb-dump -u"${DB_USER}" -p"${DB_PASS}" "${DB_NAME}" \
  | gzip > "${OUT}"

# Rotation locale
find "${BACKUP_DIR}" -type f -name "${SITE}_*.sql.gz" -mtime +{{ db_backup_retention_days }} -delete

# Copie vers NAS via NFS (si activé)
{% if db_backup_nfs_enabled and db_backup_copy_to_nas %}
NAS_DIR="{{ db_backup_nfs_mountpoint }}"

# Vérifie que c'est bien monté (sinon on échoue)
if ! mountpoint -q "${NAS_DIR}"; then
  echo "ERROR: NFS mount not present: ${NAS_DIR}" >&2
  exit 1
fi

# Copie du fichier dump vers le NAS
install -m 600 "${OUT}" "${NAS_DIR}/"
{% endif %}
