- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ db_backup_dir }}"
    state: directory
    mode: "0700"

- name: Build per-host secret dict from global secrets using site_name
  ansible.builtin.set_fact:
    secret: "{{ sites_secrets[site_name] }}"
  when: db_backup_enabled

- name: Ensure NFS client packages are installed
  ansible.builtin.apt:
    name: nfs-common
    state: present
    update_cache: true
  when: db_backup_enabled and db_backup_nfs_enabled

- name: Ensure NFS mountpoint exists
  ansible.builtin.file:
    path: "{{ db_backup_nfs_mountpoint }}"
    state: directory
    mode: "0755"
  when: db_backup_enabled and db_backup_nfs_enabled

- name: Mount Synology NFS export persistently
  ansible.posix.mount:
    path: "{{ db_backup_nfs_mountpoint }}"
    src: "{{ db_backup_nfs_server }}:{{ db_backup_nfs_export }}"
    fstype: nfs
    opts: "rw,nofail,_netdev,timeo=14"
    state: mounted
  when: db_backup_enabled and db_backup_nfs_enabled

- name: Deploy DB backup script
  ansible.builtin.template:
    src: backup_db.sh.j2
    dest: "{{ db_backup_dir }}/backup_db.sh"
    mode: "0700"

- name: Ensure required packages are installed (rsync + ssh client)
  ansible.builtin.apt:
    name:
      - rsync
      - openssh-client
    state: present
    update_cache: true
  when: db_backup_enabled

- name: Ensure cron is installed (provides crontab)
  ansible.builtin.apt:
    name: cron
    state: present
    update_cache: true
  when: db_backup_enabled

- name: Ensure cron service is enabled and running
  ansible.builtin.systemd:
    name: cron
    enabled: true
    state: started
  when: db_backup_enabled

- name: Install cron job
  ansible.builtin.cron:
    name: "WordPress DB backup (dump + rsync)"
    minute: "{{ db_backup_cron_minute }}"
    hour: "{{ db_backup_cron_hour }}"
    job: "/bin/bash {{ db_backup_dir }}/backup_db.sh"
