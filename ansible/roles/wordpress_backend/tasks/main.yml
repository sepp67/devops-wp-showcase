- name: Compute proxy IP
  ansible.builtin.set_fact:
    proxy_ip: "{{ hostvars[groups['proxy'][0]].ansible_host }}"

- name: Select site for this host
  ansible.builtin.set_fact:
    site: "{{ (sites | selectattr('name','equalto', site_name) | list | first) }}"
    secret: "{{ sites_secrets[site_name] }}"
    bind_ip: "{{ ansible_host }}"

- name: Create backend directory
  ansible.builtin.file:
    path: "{{ wp_dir }}/{{ site.name }}"
    state: directory
    mode: "0755"

- name: Create php config directory
  ansible.builtin.file:
    path: "{{ project_dir }}/php"
    state: directory
    mode: "0755"

- name: Copy custom php ini
  ansible.builtin.copy:
    src: "../../../deploy/php/custom.ini"
    dest: "{{ project_dir }}/php/custom.ini"
    mode: "0644"

- name: Deploy backend compose.yml
  ansible.builtin.template:
    src: compose.wp.yml.j2
    dest: "{{ wp_dir }}/{{ site.name }}/compose.yml"
    mode: "0644"

# Firewall: n'autoriser que le proxy sur le port backend
- name: Allow backend port only from proxy
  ansible.builtin.ufw:
    rule: allow
    port: "{{ site.backend_port }}"
    proto: tcp
    from_ip: "{{ proxy_ip }}"
  when: firewall_enabled

# Optionnel mais recommand√©: refuser 80/443 (pas besoin sur backend)
- name: Deny HTTP on backend
  ansible.builtin.ufw:
    rule: deny
    port: "80"
    proto: tcp
  when: firewall_enabled

- name: Deny HTTPS on backend
  ansible.builtin.ufw:
    rule: deny
    port: "443"
    proto: tcp
  when: firewall_enabled

- name: Start/Update backend stack
  ansible.builtin.command:
    chdir: "{{ wp_dir }}/{{ site.name }}"
    cmd: docker compose up -d --force-recreate
  changed_when: true
