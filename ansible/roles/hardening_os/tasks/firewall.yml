- name: Install ufw
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true

- name: Default deny incoming
  community.general.ufw:
    direction: incoming
    policy: deny

- name: Default allow outgoing
  community.general.ufw:
    direction: outgoing
    policy: allow

- name: Allow SSH from allowed CIDRs
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    from_ip: "{{ item }}"
  loop: "{{ hardening_os_ssh_allowed_cidrs }}"

- name: Restrict backend HTTP port to proxy only
  community.general.ufw:
    rule: allow
    port: "{{ hardening_os_backend_http_port }}"
    proto: tcp
    from_ip: "{{ hardening_os_proxy_ip }}"
  when: hardening_os_restrict_http_to_proxy

- name: Enable UFW
  community.general.ufw:
    state: enabled
